<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Conciliações - GRUPO DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--blue:#007bff;--green:#00c853;--amber:#ffb300;--red:#ff3b30;--bg:#f9f9f9}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fff;color:#111}
    header{padding:16px 12px;border-bottom:1px solid #e9e9e9;text-align:center;background:#fff;position:sticky;top:0;z-index:5}
    header img{height:56px}
    header h1{margin:6px 0 0;font-size:1.4rem}
    .container{padding:14px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin:8px 0 16px}
    .filters input[type=date],.filters select{padding:10px;border:1px solid #d0d0d0;border-radius:8px;background:#fff}
    .filters button{padding:10px 14px;border:0;border-radius:8px;background:var(--blue);color:#fff;font-weight:700;cursor:pointer}
    .card{background:var(--bg);border:1px solid #e5e5e5;border-radius:12px;padding:12px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    .empresa-section h3{margin:6px 0 8px;font-size:1rem}
    .detalhes{margin-top:8px;font-size:.95rem}
    .muted{opacity:.75}
    #statusMsg{display:none;margin:6px 0 12px}
  </style>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
  <h1>Conciliações - GRUPO DV</h1>
</header>

<div class="container">
  <div class="filters">
    <input type="date" id="filtroDataInicio">
    <input type="date" id="filtroDataFim">
    <select id="filtroEmpresa"><option value="">Todas</option></select>
    <button id="btnAplicar">Aplicar</button>
  </div>

  <div id="statusMsg"></div>

  <!-- 1) Linha geral de vendas (estilo do print) -->
  <div class="card"><canvas id="graficoLinhaVendas"></canvas></div>

  <!-- 2) Linhas por modalidade: Vendido x Recebido -->
  <div class="card"><canvas id="graficoModalidades"></canvas></div>

  <!-- 3) % Crédito recebido -->
  <div class="card"><canvas id="graficoPctCredito"></canvas></div>

  <!-- 4) Previsão x Recebido (crédito) -->
  <div class="card"><canvas id="graficoPrevisto"></canvas></div>

  <!-- 5) Pizzas por empresa (pequenas; selecionada cresce + mostra totais) -->
  <div id="graficosPizza" class="grid"></div>
</div>

<script>
// === Endpoints ===
// VENDAS vem em linhas: { Empresa, Data, Categoria, Valor }
const URL_VENDAS  = "https://script.google.com/macros/s/AKfycbz9GQLrIB4oiX0jBQ7yaDO_IiMz3ER7lQT094sp5y2VUGgQWBaz3G1fa7s4ZbiWli_O/exec";
// EXTRATO idem (para recebido): { Empresa, Data, Categoria, Valor }
const URL_EXTRATO = "https://script.google.com/macros/s/AKfycbyGSP5oj9xotdhbnLsZ4hY4m1_dEbd2YQ-N3o7Y-GCwd7RvCTlSzhYee8Jn6RdnKcx2ug/exec";

// === Estado ===
let baseVendas = [];     // linhas cruas
let baseReceb  = [];     // linhas cruas
let vendasGrp  = [];     // agrupado por (empresa,data) -> modalidades
let recebGrp   = [];     // idem para recebido

// Charts refs
let chLinha=null, chModal=null, chPct=null, chPrev=null;

// === Helpers ===
function showStatus(msg,type='info'){
  const el=document.getElementById('statusMsg');
  el.style.display='block';
  el.style.color= type==='error' ? '#c62828' : (type==='warn' ? '#ff8f00' : '#444');
  el.textContent=msg;
}

function setDefaultDates(){
  const hoje=new Date();
  const ontem=new Date(hoje); ontem.setDate(ontem.getDate()-1);
  const inicio=new Date(hoje.getFullYear(),hoje.getMonth(),1);
  document.getElementById('filtroDataInicio').value=inicio.toISOString().split('T')[0];
  document.getElementById('filtroDataFim').value=ontem.toISOString().split('T')[0];
}

// Normaliza chaves (aceita Empresa/empresa etc.)
function normalizeRows(rows){
  return (rows||[]).map(r=>({
    Empresa:  r.Empresa  ?? r.empresa ?? r.EMPRESA ?? '',
    Data:     r.Data     ?? r.data    ?? r.DATA    ?? '',
    Categoria:r.Categoria?? r.categoria?? r.CATEGORIA?? '',
    Valor:    Number(r.Valor ?? r.valor ?? r.VALOR ?? 0)
  })).filter(r=>r.Empresa && r.Data);
}

function agruparPorDiaEmpresa(lista){
  const mapa={};
  for(const {Empresa,Data,Categoria,Valor} of lista){
    const k=Empresa+'|'+Data;
    if(!mapa[k]) mapa[k]={empresa:Empresa,data:Data,debito:0,credito:0,pix:0,voucher:0,previsto:0};
    const cat=(Categoria||'').toUpperCase();
    const v=Number(Valor)||0;
    if(cat.includes('DÉBITO')) mapa[k].debito += v;
    else if(cat.includes('CRÉDITO')) mapa[k].credito += v;
    else if(cat.includes('PIX')) mapa[k].pix += v;
    else if(cat.includes('VOUCHER')) mapa[k].voucher += v;
    if(cat.includes('PREV')) mapa[k].previsto += v; // opcional: previsão
  }
  return Object.values(mapa);
}

function filtrarColecao(col){
  const ini=document.getElementById('filtroDataInicio').value;
  const fim=document.getElementById('filtroDataFim').value;
  const emp=document.getElementById('filtroEmpresa').value;
  return col.filter(d=>(!emp||d.empresa===emp) && d.data>=ini && d.data<=fim);
}

// =============== Charts ===============
function drawLinhaGeral(vendas){
  const somaDia={};
  vendas.forEach(d=>{somaDia[d.data]=(somaDia[d.data]||0)+d.debito+d.credito+d.pix+d.voucher});
  const dias=Object.keys(somaDia).sort();
  const valores=dias.map(d=>somaDia[d]);
  if(chLinha) chLinha.destroy();
  chLinha=new Chart(document.getElementById('graficoLinhaVendas'),{
    type:'line',
    data:{labels:dias,datasets:[{label:'Valor Vendido',data:valores,borderColor:'#007bff',backgroundColor:'rgba(0,123,255,.18)',fill:true,tension:.3,pointRadius:3,pointHoverRadius:5}]},
    options:{responsive:true,plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>` Valor Vendido:  R$ ${Number(ctx.parsed.y||0).toLocaleString('pt-BR')}`}}},scales:{y:{ticks:{callback:v=>`R$ ${Number(v).toLocaleString('pt-BR')}`}},x:{ticks:{maxRotation:0,autoSkip:true}}}}
  );
}

function drawModalidades(vendas,receb){
  const dias=[...new Set([...vendas.map(v=>v.data),...receb.map(r=>r.data)])].sort();
  const mods=['debito','credito','pix','voucher'];
  const cores={debito:['#0d47a1','#4fc3f7'],credito:['#1b5e20','#81c784'],pix:['#ffb300','#ffe082'],voucher:['#c62828','#ef9a9a']};
  const ds=[];
  mods.forEach(m=>{ds.push({label:`${m[0].toUpperCase()+m.slice(1)} Vendido`,data:[],borderColor:cores[m][0],fill:false});ds.push({label:`${m[0].toUpperCase()+m.slice(1)} Recebido`,data:[],borderColor:cores[m][1],fill:false});});
  dias.forEach(d=>{const v=vendas.find(x=>x.data===d)||{}; const r=receb.find(x=>x.data===d)||{}; mods.forEach((m,i)=>{ds[i*2].data.push(v[m]||0); ds[i*2+1].data.push(r[m]||0)});});
  if(chModal) chModal.destroy();
  chModal=new Chart(document.getElementById('graficoModalidades'),{type:'line',data:{labels:dias,datasets:ds},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

function drawPctCredito(vendas,receb){
  const dias=[...new Set([...vendas.map(v=>v.data),...receb.map(r=>r.data)])].sort();
  const pct=dias.map(d=>{const v=vendas.find(x=>x.data===d)?.credito||0; const r=receb.find(x=>x.data===d)?.credito||0; return v>0?Math.round((r/v)*100):0;});
  if(chPct) chPct.destroy();
  chPct=new Chart(document.getElementById('graficoPctCredito'),{type:'line',data:{labels:dias,datasets:[{label:'% de Crédito Recebido',data:pct,borderColor:'#ff3b30',fill:false}]},options:{responsive:true,scales:{y:{min:0,max:100,ticks:{callback:v=>v+'%'}}},plugins:{legend:{position:'top'}}}});
}

function drawPrevisto(vendas,receb){
  const dias=[...new Set([...vendas.map(v=>v.data),...receb.map(r=>r.data)])].sort();
  const prev=dias.map(d=>vendas.find(x=>x.data===d)?.credito||0); // crédito vendido como previsto
  const rec =dias.map(d=>receb.find(x=>x.data===d)?.credito||0);
  if(chPrev) chPrev.destroy();
  chPrev=new Chart(document.getElementById('graficoPrevisto'),{type:'bar',data:{labels:dias,datasets:[{label:'Previsto Crédito',data:prev,backgroundColor:'#66CCFF'},{label:'Crédito Recebido',data:rec,backgroundColor:'#99FFCC'}]},options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{y:{ticks:{callback:v=>`R$ ${Number(v).toLocaleString('pt-BR')}`}}}});
}

function drawPizzas(vendas,receb){
  const wrap=document.getElementById('graficosPizza');
  wrap.innerHTML='';
  const empSel=document.getElementById('filtroEmpresa').value||null;
  const empresas=[...new Set(vendas.map(v=>v.empresa))].sort();
  empresas.forEach(emp=>{
    const sec=document.createElement('div'); sec.className='card empresa-section';
    const h=document.createElement('h3'); h.textContent=emp; sec.appendChild(h);

    const totV={debito:0,credito:0,pix:0,voucher:0};
    const totR={debito:0,credito:0,pix:0,voucher:0};
    vendas.filter(x=>x.empresa===emp).forEach(x=>{totV.debito+=x.debito;totV.credito+=x.credito;totV.pix+=x.pix;totV.voucher+=x.voucher});
    receb.filter(x=>x.empresa===emp).forEach(x=>{totR.debito+=x.debito;totR.credito+=x.credito;totR.pix+=x.pix;totR.voucher+=x.voucher});

    const cnv=document.createElement('canvas'); cnv.height=(empSel===emp?240:120); sec.appendChild(cnv);
    new Chart(cnv,{type:'pie',data:{labels:['Débito','Crédito','Pix','Voucher'],datasets:[{data:[totV.debito,totV.credito,totV.pix,totV.voucher],backgroundColor:['#0d47a1','#1b5e20','#ffb300','#c62828']}]},options:{plugins:{legend:{position:'bottom'}}}});

    if(empSel===emp){
      const d=document.createElement('div'); d.className='detalhes';
      d.innerHTML=`<div><strong>Vendido</strong> — Débito: R$ ${totV.debito.toLocaleString('pt-BR')} • Crédito: R$ ${totV.credito.toLocaleString('pt-BR')} • Pix: R$ ${totV.pix.toLocaleString('pt-BR')} • Voucher: R$ ${totV.voucher.toLocaleString('pt-BR')}</div>
      <div><strong>Recebido</strong> — Débito: R$ ${totR.debito.toLocaleString('pt-BR')} • Crédito: R$ ${totR.credito.toLocaleString('pt-BR')} • Pix: R$ ${totR.pix.toLocaleString('pt-BR')} • Voucher: R$ ${totR.voucher.toLocaleString('pt-BR')}</div>
      <div class="muted"><strong>À receber</strong> — Crédito: R$ ${(totV.credito-totR.credito).toLocaleString('pt-BR')} • Voucher: R$ ${(totV.voucher-totR.voucher).toLocaleString('pt-BR')}</div>`;
      sec.appendChild(d);
    }

    wrap.appendChild(sec);
  });
}

// =============== Boot ===============
async function boot(){
  try{
    // garante datas padrão sempre que abrir a página
    setDefaultDates();
    showStatus('Carregando dados...', 'info');

    const [vRaw,rRaw]=await Promise.all([
      fetch(URL_VENDAS).then(x=>x.json()).catch(()=>[]),
      fetch(URL_EXTRATO).then(x=>x.json()).catch(()=>[])
    ]);

    baseVendas=normalizeRows(vRaw||[]);
    baseReceb =normalizeRows(rRaw||[]);

    if(baseVendas.length===0 && baseReceb.length===0){
      showStatus('Nenhum dado retornado dos scripts. Verifique URLs/permissões.', 'warn');
    } else {
      showStatus('Dados carregados.', 'info');
    }

    vendasGrp=agruparPorDiaEmpresa(baseVendas);
    recebGrp =agruparPorDiaEmpresa(baseReceb);

    // Popular empresas com o que existir
    const nomes=new Set([
      ...baseVendas.map(x=>x.Empresa),
      ...baseReceb.map(x=>x.Empresa)
    ].filter(Boolean));
    const sel=document.getElementById('filtroEmpresa');
    sel.innerHTML='<option value="">Todas</option>';
    [...nomes].sort().forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o)});

    aplicarFiltrosEDesenhar();
  }catch(e){
    console.error(e);
    showStatus('Erro ao carregar/desenhar: '+e.message, 'error');
  }
}

function aplicarFiltrosEDesenhar(){
  const vFil=filtrarColecao(vendasGrp);
  const rFil=filtrarColecao(recebGrp);
  drawLinhaGeral(vFil);
  drawModalidades(vFil,rFil);
  drawPctCredito(vFil,rFil);
  drawPrevisto(vFil,rFil);
  drawPizzas(vFil,rFil);
}

// Eventos
window.addEventListener('DOMContentLoaded', ()=>{
  setDefaultDates();
  boot();
});

document.getElementById('btnAplicar').addEventListener('click',aplicarFiltrosEDesenhar);
</script>
</body>
</html>
